//Platform includes
#include <Arduino.h>
#include <SPI.h>



//Local includes
#include "main.h"
#include "mc_freertos.h"
#include "HAL/include/mc_button.h"
#include "HAL/include/mc_commands.h"
#include "HAL/include/mc_led.h"

#include "types.h"



// #include "images.h"



//External variables


  // uint8_t test_width = 50;
  // uint8_t test_height = 40;
  // unsigned char WifiFull[] = {
  //   0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x07,
  //   0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0xfc, 0xff,
  //   0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00, 0xc0,
  //   0xff, 0xff, 0xff, 0xff, 0x0f, 0x00, 0xe0, 0xff, 0x03, 0x00, 0xff, 0x1f,
  //   0x00, 0xf0, 0x7f, 0x00, 0x00, 0xf8, 0x3f, 0x00, 0xf8, 0x1f, 0x00, 0x00,
  //   0xe0, 0x7f, 0x00, 0xfc, 0x07, 0xc0, 0x0f, 0x80, 0xff, 0x01, 0xfe, 0x01,
  //   0xfe, 0xff, 0x00, 0xfe, 0x01, 0xff, 0x80, 0xff, 0xff, 0x07, 0xfc, 0x03,
  //   0x7f, 0xe0, 0xff, 0xff, 0x1f, 0xf8, 0x03, 0x3f, 0xf8, 0xff, 0xff, 0x7f,
  //   0xf0, 0x03, 0x0e, 0xfc, 0xff, 0xff, 0xff, 0xc0, 0x01, 0x00, 0xfe, 0x1f,
  //   0xe0, 0xff, 0x01, 0x00, 0x00, 0xff, 0x03, 0x00, 0xff, 0x03, 0x00, 0x80,
  //   0xff, 0x00, 0x00, 0xfc, 0x07, 0x00, 0xc0, 0x3f, 0x00, 0x00, 0xf0, 0x0f,
  //   0x00, 0xc0, 0x1f, 0xf0, 0x3f, 0xe0, 0x0f, 0x00, 0xc0, 0x0f, 0xfc, 0xff,
  //   0xc0, 0x0f, 0x00, 0x80, 0x07, 0xff, 0xff, 0x83, 0x07, 0x00, 0x00, 0x80,
  //   0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x0f, 0x00, 0x00,
  //   0x00, 0xe0, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0xf0, 0x1f, 0xe0, 0x3f,
  //   0x00, 0x00, 0x00, 0xf0, 0x07, 0x80, 0x3f, 0x00, 0x00, 0x00, 0xf0, 0x03,
  //   0x00, 0x3f, 0x00, 0x00, 0x00, 0xe0, 0x81, 0x07, 0x1e, 0x00, 0x00, 0x00,
  //   0xc0, 0xe0, 0x1f, 0x0c, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00,
  //   0x00, 0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x7f,
  //   0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  //   0xf8, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00,
  //   0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x3f, 0x00,
  //   0x00, 0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
  //   0x07, 0x00, 0x00, 0x00 };







//global variables
uint8_t system_state = STATE_INIT;
// uint8_t wifi_init_done = false;
uint8_t lcd_init_done = false;







// hspi = new SPIClass(HSPI);


//define freertos object
mc_freertos rtos;
// mc_button   button = mc_button();
mc_commands cmd;
mc_led      led;

mc_database database;




//TODO Critical features
//  TODO WIFI connect, disconnect stateflow
//  TODO Add HTTP stuff
//  TODO Add LCD stuff
//  TODO Add an "Not yet checked" button option when holding a button


//TODO Nice to haves when everything works
//  TODO add fading in/out LED's when uploading to server


void print_debug_messages();

bool button_changed = false;


void button_changed_ISR() {
  button_changed = true;
}



void setup() {

  Debug.begin(115200);

  print_debug_messages();

  pinMode(CHECK_INT_PIN, INPUT);


  delay(3000);


  Serial.println("LED Init");
  led.init();


  

  // attachInterrupt(CHECK_INT_PIN, button_changed_ISR, FALLING);

  // button.init();

  Serial.println("RTOS Init");
  rtos.init();

}

void loop() {

  if(button_changed == 1){
    Serial.print("State:");
    Serial.println(digitalRead(CHECK_INT_PIN));

    button_changed = 0;
  }


}


void print_debug_messages(){

  #ifdef DEBUG_ADC
    Debug.println("Debug ADC enabled");
  #endif

  #ifdef DEBUG_BUTTON_PRESS_RELEASE
    Debug.println("Debug Button press/release enabled");
  #endif
  
  #ifdef DEBUG_CURRENT_BUTTON
    Debug.println("Debug Current Button enabled");
  #endif

  #ifdef DEBUG_CURRENT_MENU_BUTTON
    Debug.println("Debug Current Menu Buttons enabled");
  #endif

  #ifdef DEBUG_MENU_BUTTON_PRESS_RELEASE
    Debug.println("Debug Menu Button press/release enabled");
  #endif


  #ifdef DEBUG_ITEMS
    Debug.println("Debug Items enabled");
  #endif

}